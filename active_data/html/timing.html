<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="text/javascript" src="modevlib/imports/import.js"></script>
</HEAD>
<BODY style="position:relative;">

<div style="position:absolute;left:10px;right:10px;">
	<h3 id="title">Buildbot Timings<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span></h3>

	<div id="details" style="overflow-y: scroll;height:300px;position:absolute;right:10px;left:10px;"></div>
	<!--<div id="chart" class="chart" style="text-align:center;width:800px;height:300px;"></div>-->
</div>


<script type="application/javascript">


importScript(['js/util.js'], function(){

	var focusFilter = {"eq": {"build.platform": "win32"}};


	var __main = function*(){
		var all_steps = null;

		var a = Log.action("find steps", true);
		try {
			var result = yield (search({
				"select": [
					{"value": "order", "aggregate": "average"},
					{"aggregate": "count"}
				],
				"edges": [
					{
						"name": "step",
						"value": ["builder.step", "harness.step"]
					}
				],
				"from": "jobs.action.timings",
				"where": focusFilter,
				"limit": 1000,
				"format": "list"
			}));
			all_steps = result.data;
		} catch (e) {
			Log.error("Find steps", e);
		} finally {
			Log.actionDone(a);
		}//try

		// DETERMINE THE MOST POPULAR STEPS
		var populous = Qb.sort(all_steps, {"value": "count", "sort": -1});
		var population = populous[0].count;
		var stop = 0;
		populous.forall(function(v, i){
			if (stop == 0 && i > 0 && v.count * 10 < population){
				stop = i;
			}//endif
		});
		populous=populous.slice(0, stop);

		var steps = Qb.sort(populous, "order");

		Thread.run(function*(){
			//PULL THE AVERAGE TIME FOR EACH STEP
			var step_timings=null;

			var a = Log.action("find durations", true);
			try {
				//PULL FAILURE DETAILS
				var result = yield (search({
					"select": [
						{"value": "order", "aggregate": "average"},
						{"name":"duration", "value": {"coalesce":["builder.duration", "harness.duration"]}, "aggregate": "average"},
						{"aggregate":"count"}
					],
					"groupby": ["builder.step", "harness.step"],
					"from": "jobs.action.timings",
					"where": {"and": [
						focusFilter,
						{"or": steps.select("step").map(function(v){
							return {"eq": {"action.timings.builder.step": v[0], "action.timings.harness.step": v[1]}};
						})}
					]},
					"limit": 1000,
					"sort":"order",
					"format": "list"
				}));
				step_timings = result;
			} catch (e) {
				Log.error("Find steps", e);
			} finally {
				Log.actionDone(a);
			}//try

			$("#details").html(convert.List2HTMLTable(step_timings));

			yield (null);
		});

		Thread.run(function*(){
			//SHOW TIMES OVER PAST FEW WEEKS


		});


		yield (null);
	};


	Thread.showWorking = function(numThread){
		var l = $(".loading");
		l.show();
	};//function

	Thread.hideWorking = function(){
		var l = $(".loading");
		l.hide();
	};//function


	var thread;
	var main = function(){
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__main());
//		thread = Thread.run(__testChart());
	};

	$(document).ready(function(){
		main();
	});

});

</script>


</BODY>
</HTML>

