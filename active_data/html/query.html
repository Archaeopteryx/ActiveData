<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<!--
THIS IS A DEMONSTRATION OF USING THE ESQueryRunner
-->

<HEAD>
	<link type="text/css" rel="stylesheet" href="css/menu.css">
	<link type="text/css" rel="stylesheet" href="lib/jquery-linedtextarea/jquery-linedtextarea.css">
	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="lib/jquery-linedtextarea/jquery-linedtextarea.js"></script>
	<script type="text/javascript" src="lib/jsonlint/jsl.parser.js"></script>
	<script type="text/javascript" src="lib/jsonlint/jsl.format.js"></script>

	<script type="text/javascript" src="modevlib/imports/import.js"></script>
	<script type="text/javascript" src="js/ESQueryRunner.js"></script>
</HEAD>
<BODY>
<div class="warning">This message will be removed if you have FF27+, or Chrome (with experimental Javascript enabled)</div>


<div id="sidebar">
	<br><br>

	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Ready</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description">
		Converts Qb queries to ElasticSearch queries.
		<ul>
			<li><a href="https://github.com/klahnakoski/ActiveData/blob/master/docs/Qb_Tutorial.md">Unittest Tutorial</a></li>
			<li><a href="https://github.com/klahnakoski/ActiveData/blob/master/docs/Unittest%20Schema.md">Unittest Schema</a></li>
			<li><a href="https://github.com/klahnakoski/ActiveData/blob/master/docs/Qb_Expressions.md">Qb Expressions</a></li>
			<li><a href="https://github.com/klahnakoski/ActiveData/blob/master/docs/Qb_Reference.md">Reference Documentation</a></li>
			<li><a href="https://github.com/klahnakoski/ActiveData/blob/master/docs/BZ_Tutorial.md">Bugzilla Tutorial</a></li>
			<li><a href="https://github.com/klahnakoski/ActiveData">ActiveData code on Github</a></li>
		</ul>
	</div>
</div>
<h3>ActiveData Query Tool</h3>


<div style="width:800px;float: left;">
	<textarea name="cube" id="cube" style="width:800px;height:250px;"></textarea>

	<div id="execute" class="button">EXECUTE</div>
	<div id="success" style="display: inline-block;padding-left: 30px;">
		<div id="copy" class="button">Copy</div>
		<div id="share" class="button">Share</div>
		<div id="tab" class="button">as Table</div>
		<div id="json" class="button">as Json</div>
	</div>
	<textarea name="notes" id="notes" style="width:800px;height:250px;"></textarea>

	<div id="result" style="overflow: scroll;width:800px;height:250px;"></div>
</div>


<script>
function setupBusySpinner(){
	$(".loading").hide();

	Thread.showWorking = function(numThread){
		if (numThread) {
			var l = $(".loading");
			l.show();
		}//endif
	};//function

	Thread.hideWorking = function(){
		var l = $(".loading");
		l.hide();
	};//function

	Thread.run(function*(){
		$(".warning").html("");
	});

}

importScript([], function(){
	setupBusySpinner();

	$().ready(function(){
		//STYLE AS LINED TEXT AREAQ
		$("#cube").linedtextarea();

		$("#share").click(function(){
			if (queryTool.shareLink !== undefined) {
				window.prompt("Copy to clipboard: Ctrl+C, Enter", queryTool.shareLink);
			}//endif
		});

		$("#copy").click(function(){


		});

		$("#execute").click(function(event){
			$("#result").html("");
			queryTool.executeCube();
		});//method

		queryTool.setup();

	});

});

var queryTool = {};
(function(){
	queryTool.response = null;
	queryTool.shareLink = null;

	queryTool.setup = function(){
		$("#cube").prop('disabled', true).val("Loading query...");
		this.hideAll();

		var self = this;
		var loc = window.location.href;
		var anchor = convert.URLParam2Object(loc.split("#")[1]);
		if (anchor.find!==undefined) {
			Thread.run(function*(){
				try {
					var response = yield(Rest.get({
						"url": "/find/" + anchor.find,
						"data": ""
					}));

					$("#cube").prop('disabled', false).val(convert.value2json(response));
					self.executeCube();
					yield (response);
				} catch (e) {
					Log.error("Call to ActiveData failed", e)
				}//try
			});
		}//endif

	};//function

	queryTool.hideAll=function hideAll(){
		//EVAL THE Qb
		self.shareLink=undefined;
		$("#notes").hide();
		$("#success").hide();
		$("#results").hide();
	}//function

	queryTool.executeCube = function(event){
		var self = this;

		//EVAL THE Qb
		self.hideAll();

		var code = $("#cube").val();
		if (code.trim().left(1) != "{") code = "{" + code;
		if (code.trim().right(1) != "}") code = code + "}";

		Thread.run(function*(){
			var a = Log.action("Send query", true);
			try {
				//USE JSONLINT TO FORMAT AND TEST-COMPILE THE code
				code = jsl.format.formatJson(code);
				$("#cube").val(code);
				var query = jsl.parser.parse(code);
				//REQUEST A URL FOR SHARING
				query.meta = {};
				query.meta.save = true;

				self.response = yield(ESQueryRunner(query));
				var rows;
				if (self.response.meta && self.response.meta.format == "cube") {
					self.response.cube = self.response.data;
					rows = Qb.Cube2List(self.response);
				} else if (self.response.meta && self.response.meta.format == "table") {
					self.response.columns = self.response.header;
					rows = convert.Table2List({"columns": self.response.header, "rows": self.response.data});
				} else if (self.response.meta && self.response.meta.format == "list") {
					rows = self.response.data;
				} else if (self.response.cube !== undefined) {
					rows = Qb.Cube2List(self.response);
				} else if (self.response.list !== undefined) {
					rows = self.response.list
				} else {
					$("#result").html(convert.String2HTML(convert.value2json(self.response)));
					return
				}//endif

				$("#cube").val(convert.value2json(convert.json2value(code)));
				$("#result").html("<div>" + rows.length + " rows (up to 3000 shown)</div>" + convert.List2HTMLTable(rows, {"limit": 3000})).show();
				$("#success").show();

				var loc = window.location.href.split("#")[0];
				self.shareLink =  loc + "#find=" + self.response.meta.saved_as;
			} catch (e) {
				$("#notes").show().val(e.toString());
			} finally {
				Log.actionDone(a);
			}//try
		});
	};
})();

</script>


</BODY>
</HTML>
