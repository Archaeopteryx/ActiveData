<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>Intermittent Failures</title>
	<script type="application/javascript" src="./modevlib/imports/import.js"></script>
</head>
<body>
	<h2>Search for failure by test name:</h2>
	<div>
		<input id="testName" name="testName" layout="left=page.left; right=page.right" style="padding:3px 20px 3px 20px;">
	</div>
	<div id="matches">
	</div>
	<div id="summary" layout="top=matches.bottom;right=page.right"></div>
	<div id="results" layout="top=matches.bottom;left=page.left;right=summary.left;">
	</div>
</body>

<script>


importScript([
	"lib/jquery.js",
	"modevlib/threads/thread.js",
	"modevlib/util/aTemplate.js",
	"modevlib/layouts/layout.js",
	"js/ActiveData.js"
], function(){
	layoutAll();

	var MATCH_TEMPLATE = new Template({
		"from": ".",
		"template": '<div id="singleMatch" class="hoverable">' +
			'    <div>{{testName}}</div>' +
			'    <div>{{count}}</div>' +
			'</div>'
	});

	var activeData=new ActiveData();

	(function(){
		var currentQuery=null;
		var lastValue=null;

		Thread.run(function*(){
			while(true) {
				var testName = $("#testName").val();
				if (testName == lastValue) return;
				if (testName.trim().length == 0) return;
				lastValue = testName;

				currentQuery = Thread.run(function*(){
					var matches = yield (findMatches(activeData, testName));
					if (Thread.currentThread != currentQuery)
						yield null;   //WAS CANCELLED
					$("#matches").html(MATCH_TEMPLATE.expand(matches));
				});
				Thread.sleep(500);
			}//while
		});
	})();




});




function* findMatches(activeData, words){
	var matcher = ".*(" + words.split(" ").map(function(w){
		if (w.length == 0) return undefined;
		return convert.String2Regexp(w);
	}).join("|") + ").*";

	var counter = {
		"from": "unittest",
		"select": {"aggregate": "count"},
		"edges": ["result.test"],
		"where": {"and": [
			{"or": [
				{"regexp": {"result.test": matcher}},
				{"regexp": {"run.suite": matcher}},
				{"regexp": {"build.branch": matcher}}
			]},
			{"gt": {"run.timestamp": "{{today-month}}"}},
			{"eq": {"result.ok": false}}
		]}
	};

	var count = yield (activeData.query(counter));

	yield (count.data);
}//function

function* summary(activeData, testName){
	//FIND FIRST INSTANCE
	var min_query = {
		"from": "unittest",
		"select":{"name":"firstSeen", "value":"run.timestamp", "aggregate":"min"},
		"where": {"and": [
			{"eq": {"run.result.test": testName}},
			{"gt": {"run.timestamp": "{{today-month}}"}}
		]}
	};

	var min_result = yield (activeData.query(min_query));

	var summary = {
		"from": "unittest",
		"edges": [
			{"name": "branch", "value": "build.branch"},
			{"name": "platform", "value": "build.platform"},
			{"name": "ok", "value": "run.result.ok"}
		],
		"where": {"and": [
			{"eq": {"run.result.test": testName}},
			{"gt": {"run.timestamp": min_result.data.firstSeen}}
		]},
		"limit":100000
	};

	var output = (yield (activeData.query(summary))).data;
	yield output;
}//function

function* details(activeData, testName){
	var details = {
		"from": "unittest",
		"where": {"and": [
			{"eq": {
				"run.result.ok": false,
				"run.result.test": testName
			}},
			{"gt": {"run.timestamp": "{{today-month}}"}}
		]},
		"limit":100000
	};

	var output = (yield (activeData.query(details))).data;
	yield output;

}//function


</script>




</html>
